OpenScholar migration  
=====================

Upgrading OpenScholar from Drupal 6 to Drupal 7 uses the Migrate module instead of the standard Drupal upgrade path.  This document details how to to OpenScholar migrate to perform the upgrade.  

The general process is as follows: 

1. Install OpenScholar 3 or higher on a separate installation.  
2. Enable the os_migrate module.  
3. Suspend service to your D6 installation.
4. (optional) Copy D6's database and files to some place D7 can see them.  If you're keeping them on the same server, you can probably skip this step.
5. Configure os_migrate `/admin/config/openscholar/migrate`.
   * At a minimum you will need to provide a database and path.  
6. Run migration.  You can do this in admin/content/migrate or via drush.  
7. Check that migration went smoothly.  Fix anything that didn't.
8. Make whatever DNS or server configuration changes are necessary so your domain uses your new installation.

## Installation

!! unsure how installation will go.
* Installation is just like it was in D6.  
* Acquire the openscholar profile.  Acquire D7.  Follow Drupal SOP, selecting openscholar as profile.
* Drush make?

## Module

Enable os_migrate

## Service

Suspend service to your drupal 6 installation.  If downtime is acceptable maintenance mode will suffice.  We disabled user logins so no content could be created, but old content was still viewable.

## Copy

Copy your database and files.  This is unecessary if you're installing side by side with d6.  We used the migration as an opportunity to move servers.  When copying files, use symlinks to keep the directory structure intact.  If you're using rsync to do the copying, use "--exclude js/* --exclude css/*" to ignore cached javascript and css.

## Configuration

OpenScholar Migrate provides the following settings, configurable at `/admin/config/openscholar/os_migrate`

### Migration Database

*Required*

For migrate to copy content from your legacy database into drupal 7, it needs to be able to read the database.  This configuration has two parts.  First, you need to modify your settings.php to define a legacy database connection.  Add something like this to your D7 settings.php:

```
$databases['my_legacy_database']['default'] = array(
    'database' => 'db name',
    'username' => 'db user',
    'password' => 'db password',
    'host' => 'localhost',
    'port' => '',
    'driver' => 'mysql',
    'prefix' => '',
);
```

Replace db name, db user, db password with the appropriate credentials to access your D6 database.  (Hint: if you're copying directly off of D6 instead of off a backup, these can be found in D6's settings.php).  

You can change my_legacy_database to whatever you want, but make sure to set that as the Migration database. 

### Files directory

*Required*

To copy files from your previous installation, migrate needs the path to those files.  You can point this to your legacy drupal installation or a copy of the files.

Note that drupal keeps a fragment of the file path in its DB.  If the full path to your drupal files is /var/www/openscholar/sites/default/files, sites/default/files will already be saved to the db as part of the files path.  Therefore you only need to provide /var/www/openscholar.

Files directory and migration database are required.  They will be checked when their form is saved.  The remaining settings are not strictly necessary, but may be helpful for debugging or development purposes.

### Email Suppression

Creating a user account during migration will send that user an email. Leaving this checked will suppress emails during user migration. It will also block OpenScholar's Mailchimp subscription.

### Group Bundle

Vsite content types have changed. This option selects which content type your vsites will migrate into. By default, vsites will become personal and projects will remain projects.

### Ignore Dependencies

Force migrate to ignore dependencies.  Some of the migration classes won't run until earlier classes have been completed.  For example, nodes need inline images to be copied before the node can copy.   

### Force Group ID

Overrides the group nodes belong to and put them all into a new group with this ID.  

### Legacy Site

Provide a link to the D6 site.  Some debug messages will try to link to the original content.

### Dynamic Migration

Several migrations - comments and taxonomy terms in particular - are generated by other migration processes.  This link will force them to be generated again.  http://drupal.org/node/1006998

### Treat source as domain

Ignore this if you're running migrate against a single domain.  We had several installations to migrate and had to specify that certain changes only happened on certain installations.  By default that was determined by the site's domain.  This setting lets you override the domain and tell migration that you're really migrating from server2 even if it looks like dev-server1.

### Restrict vsites

During testing we found it useful to restrict migration to one or two problematic vsites so we could test those in isolation.  This setting takes a comma separated list of vsite node ids and (mostly) limits migration to those vsites.  

## Running migration

Migrate can be run from the UI admin/content/migrate or from drush.  Drush is the preferred method.

Migrate is divided into classes that handle migrating different portions of your openscholar installation.  You can't migrate a page node, until that page's vsite has already been created for example.

Migrate is supposed to sort these dependencies automatically, but we found it easier to run them individually in the order we wanted.  The general ordering is:

1. Group: tablecopy
2. Users
3. Group: specialtables
4. Group: inline
5. Vsites
6. Group: nodes
7. Group: comments
8. Vocabulary
9. Group: taxonomy
10. Group: spacesoverrides
11. Everything else.

We ran that with the following shell script (which takes two args, one is the drush alias, the second is the domain of the site (since drush can't always determine that accurately)).
```
#!/bin/sh

HOST=$1
DOMAIN=$2
START_DATE=$(date)

drush $HOST mi -l $DOMAIN --group=tablecopy &&
drush $HOST mi -l $DOMAIN UsersOS &&
drush $HOST mi -l $DOMAIN BookTableOS,MenuLinksTableOS,ModalImageNodeOS &&
drush $HOST mi -l $DOMAIN --group=specialtables &&
drush $HOST mi -l $DOMAIN --group=inline &&
drush $HOST mi -l $DOMAIN VsiteNodeOS &&
drush $HOST mi -l $DOMAIN BiblioNodeOS 
drush $HOST mi -l $DOMAIN --group=node &&
drush $HOST mi -l $DOMAIN --group=comments &&
drush $HOST mi -l $DOMAIN VocabularyOS &&
drush $HOST mi -l $DOMAIN --group=taxonomy &&
drush $HOST mi -l $DOMAIN SpacesOverridesBoxesMedia &&
drush $HOST mi -l $DOMAIN --group=spacesoverrides &&
drush $HOST mi -l $DOMAIN ThemeOS,OgUsersOS &&
drush $HOST mi -l $DOMAIN --group=tablecopy &&
drush $HOST mi -l $DOMAIN --group=taxonomy 

echo -e "Started: $START_DATE\nComplete: $(date)\n"
```



## Check migration

Look over your site and check that everything went as you expected.  See the known_issues.md file for a list of hints.
If you need to test vsites with custom domains, those domains can be found in 'purl WHERE provider="vsite_domain" ' and 'spaces_overrides WHERE object_id="vsite_domain_name"' tables. 

## Server conf

Update your DNS settings to use your drupal 7 installation.  How to manage DNS is out of the scope of this document.

